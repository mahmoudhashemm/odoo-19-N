#!/bin/bash
set -euo pipefail

# Usage:
# ./run.sh DESTINATION PORT CHAT PORT8069 PORT8072 SUBNET GATEWAY ODOO_IP DB_IP [NETWORK_NAME] [IP_RANGE]
if [ $# -lt 9 ]; then
  echo "Usage: $0 DESTINATION PORT CHAT PORT8069 PORT8072 SUBNET GATEWAY ODOO_IP DB_IP [NETWORK_NAME] [IP_RANGE]"
  exit 1
fi

DESTINATION="$1"
PORT="$2"
CHAT="$3"
PORT8069="$4"
PORT8072="$5"
SUBNET="$6"
GATEWAY="$7"
ODOO_IP="$8"
DB_IP="$9"
NETWORK_NAME="${10:-${DESTINATION}_net6}"
IP_RANGE="${11:-$SUBNET}"

# Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ø±ÙŠØ¨Ùˆ
git clone --depth=1 https://github.com/mahmoudhashemm/odoo-19-N.git "$DESTINATION"
rm -rf "$DESTINATION/.git"

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯Ø§Øª ÙˆØµÙ„Ø§Ø­ÙŠØ§Øª
mkdir -p "$DESTINATION/postgresql" "$DESTINATION/enterprise"
chmod +x "$DESTINATION/entrypoint.sh" 2>/dev/null || true
sudo chmod -R 777 "$DESTINATION"

# Ø¥Ø¹Ø¯Ø§Ø¯ inotify
if grep -qF "fs.inotify.max_user_watches" /etc/sysctl.conf; then
  grep -F "fs.inotify.max_user_watches" /etc/sysctl.conf
else
  echo "fs.inotify.max_user_watches = 524288" | sudo tee -a /etc/sysctl.conf
fi
sudo sysctl -p

# Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
sed -i 's/#.*$//' "$DESTINATION/docker-compose.yml"

# ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… ÙÙŠ yml Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Delimiter Ø¢Ù…Ù† #
sed -i "s#10019#${PORT}#g"              "$DESTINATION/docker-compose.yml"
sed -i "s#20014#${CHAT}#g"              "$DESTINATION/docker-compose.yml"
sed -i "s#:8069\"#:${PORT8069}\"#g"     "$DESTINATION/docker-compose.yml"
sed -i "s#:8072\"#:${PORT8072}\"#g"     "$DESTINATION/docker-compose.yml"
sed -i "s#172.28.10.0/29#${SUBNET}#g"   "$DESTINATION/docker-compose.yml"
sed -i "s#172.28.10.1#${GATEWAY}#g"     "$DESTINATION/docker-compose.yml"
sed -i "s#172.28.10.2#${ODOO_IP}#g"     "$DESTINATION/docker-compose.yml"
sed -i "s#172.28.10.3#${DB_IP}#g"       "$DESTINATION/docker-compose.yml"
sed -i "s#odoo-net6#${NETWORK_NAME}#g"  "$DESTINATION/docker-compose.yml"

# ØªØ¹Ø¯ÙŠÙ„ odoo.conf
sed -i "s#8069#${PORT8069}#g" "$DESTINATION/etc/odoo.conf"
sed -i "s#8072#${PORT8072}#g" "$DESTINATION/etc/odoo.conf"

# ØªÙ†Ø²ÙŠÙ„ enterprise
if git ls-remote git@github.com:mahmoudhashemm/odoo19pro >/dev/null 2>&1; then
  git clone --depth 1 --branch main git@github.com:mahmoudhashemm/odoo19pro "$DESTINATION/enterprise"
else
  git clone --depth 1 --branch main https://github.com/mahmoudhashemm/odoo19pro "$DESTINATION/enterprise" || true
fi

# Ø·Ø¨Ø§Ø¹Ø© yml Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
echo "===== docker-compose.yml after modifications ====="
#cat "$DESTINATION/docker-compose.yml"
echo "=================================================="

# ØªØ´ØºÙŠÙ„ Odoo
cd "$DESTINATION"
if command -v docker >/dev/null 2>&1 && docker compose version >/dev/null 2>&1; then
  docker compose up -d
else
  docker-compose up -d
fi

echo "âœ… Started Odoo @ http://localhost:${PORT}"
echo "ğŸ”‘ Master Password: Omar@012"
echo "ğŸŒ Network: ${NETWORK_NAME} | Subnet: ${SUBNET} | IP Range: ${IP_RANGE}"
echo "ğŸ“¦ Odoo IP: ${ODOO_IP} | DB IP: ${DB_IP}"
